<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Donate & Comment</title>
    <!-- Bootstrap 5 CSS -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >
</head>
<body>
<div class="container py-4">

    <!-- Make a Donation -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h1 class="card-title mb-4">Make a Donation</h1>
            <form id="donation-form">
                <div class="mb-3">
                    <label for="userId" class="form-label">Your User ID</label>
                    <input
                            type="text"
                            class="form-control"
                            id="userId"
                            value="user1"
                            required
                    >
                </div>
                <div class="mb-3">
                    <label for="campaignId" class="form-label">Campaign ID</label>
                    <input
                            type="text"
                            class="form-control"
                            id="campaignId"
                            placeholder="e.g. campA"
                            required
                    >
                </div>
                <div class="mb-3">
                    <label for="amount" class="form-label">Amount</label>
                    <input
                            type="number"
                            class="form-control"
                            id="amount"
                            min="0.01"
                            step="0.01"
                            required
                    >
                </div>
                <button type="submit" class="btn btn-primary">Donate</button>
            </form>
            <div id="donation-msg" class="mt-3"></div>
        </div>
    </div>

    <!-- Donation History -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h2 class="card-title mb-3">Your Donation History</h2>
            <div class="d-flex align-items-center mb-3">
                <button id="view-history" class="btn btn-secondary me-2">
                    View My Donation History
                </button>
                <a href="donation-history.html" class="btn btn-link">
                    See Full Donation History
                </a>
            </div>
            <ul id="history" class="list-group"></ul>
        </div>
    </div>

    <!-- Leave a Comment -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h1 class="card-title mb-4">Leave a Comment</h1>
            <form id="comment-form">
                <div class="mb-3">
                    <label for="cUserId" class="form-label">Your User ID</label>
                    <input
                            type="text"
                            class="form-control"
                            id="cUserId"
                            value="user1"
                            required
                    >
                </div>
                <div class="mb-3">
                    <label for="cCampaignId" class="form-label">Campaign ID</label>
                    <input
                            type="text"
                            class="form-control"
                            id="cCampaignId"
                            placeholder="e.g. campA"
                            required
                    >
                </div>
                <div class="mb-3">
                    <label for="commentText" class="form-label">Comment</label>
                    <textarea
                            class="form-control"
                            id="commentText"
                            rows="3"
                            placeholder="Your supportive message…"
                            required
                    ></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Post Comment</button>
            </form>
            <div id="comment-msg" class="mt-3"></div>
        </div>
    </div>

    <!-- Comments List -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h2 class="card-title mb-3">Comments</h2>
            <button id="refresh-comments" class="btn btn-secondary mb-3">
                Refresh Comments
            </button>
            <ul id="comments" class="list-group"></ul>
        </div>
    </div>

</div>

<script>
    const API = '/donations';

    // — Donation section —
    const dForm   = document.getElementById('donation-form');
    const dMsg    = document.getElementById('donation-msg');
    const histEl  = document.getElementById('history');
    const viewBtn = document.getElementById('view-history');

    viewBtn.addEventListener('click', () => loadHistory(getUser()));

    dForm.addEventListener('submit', async e => {
        e.preventDefault();
        clearMsg(dMsg);
        try {
            const resp = await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId:     getUser(),
                    campaignId: document.getElementById('campaignId').value.trim(),
                    amount:     parseFloat(document.getElementById('amount').value)
                })
            });
            if (!resp.ok) throw new Error(await resp.text());
            const d = await resp.json();
            showMsg(dMsg, `✓ Donated $${d.amount.toFixed(2)} to ${d.campaignId}!`, 'success');
            dForm.reset();
            loadHistory(getUser());
        } catch (err) {
            showMsg(dMsg, err.message, 'error');
        }
    });

    async function loadHistory(userId) {
        histEl.innerHTML = '';
        clearMsg(dMsg);
        try {
            const resp = await fetch(`${API}?userId=${encodeURIComponent(userId)}`);
            if (!resp.ok) throw new Error('Could not load history');
            const list = await resp.json();
            if (!list.length) {
                histEl.innerHTML = '<li class="list-group-item">No donations yet.</li>';
                return;
            }
            for (const d of list) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.textContent = `#${d.id.slice(0,8)} — $${d.amount.toFixed(2)}`;
                if (!d.canceled) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-outline-danger';
                    btn.textContent = 'Cancel';
                    btn.addEventListener('click', () => cancelDonation(d.id, userId));
                    li.appendChild(btn);
                } else {
                    li.classList.add('text-muted');
                    li.textContent += ' (canceled)';
                }
                histEl.appendChild(li);
            }
        } catch (err) {
            showMsg(dMsg, err.message, 'error');
        }
    }

    async function cancelDonation(id, userId) {
        clearMsg(dMsg);
        try {
            const resp = await fetch(`${API}/${id}`, { method: 'DELETE' });
            if (!resp.ok) throw new Error('Cancel failed');
            showMsg(dMsg, '↺ Donation canceled.', 'success');
            loadHistory(userId);
        } catch (err) {
            showMsg(dMsg, err.message, 'error');
        }
    }

    // — Comment section —
    const cForm  = document.getElementById('comment-form');
    const cMsg   = document.getElementById('comment-msg');
    const comEl  = document.getElementById('comments');

    document.getElementById('refresh-comments')
        .addEventListener('click', () => {
            const camp = document.getElementById('cCampaignId').value.trim();
            if (camp) loadComments(camp);
        });

    cForm.addEventListener('submit', async e => {
        e.preventDefault();
        clearMsg(cMsg);
        const camp = document.getElementById('cCampaignId').value.trim();
        try {
            const resp = await fetch(`${API}/${encodeURIComponent(camp)}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: document.getElementById('cUserId').value.trim(),
                    text:   document.getElementById('commentText').value.trim()
                })
            });
            if (!resp.ok) throw new Error(await resp.text());
            showMsg(cMsg, '✓ Comment posted!', 'success');
            cForm.reset();
            loadComments(camp);
        } catch (err) {
            showMsg(cMsg, err.message, 'error');
        }
    });

    async function loadComments(camp) {
        comEl.innerHTML = '';
        clearMsg(cMsg);
        try {
            const resp = await fetch(`${API}/${encodeURIComponent(camp)}/comments`);
            if (!resp.ok) throw new Error('Could not load comments');
            const list = await resp.json();
            if (!list.length) {
                comEl.innerHTML = '<li class="list-group-item">No comments yet.</li>';
                return;
            }
            for (const c of list) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent =
                    `${c.userId}: ${c.text}` +
                    (c.timestamp
                        ? ` (${new Date(c.timestamp).toLocaleString()})`
                        : '');
                comEl.appendChild(li);
            }
        } catch (err) {
            showMsg(cMsg, err.message, 'error');
        }
    }

    function getUser() { return document.getElementById('userId').value.trim(); }

    // use Bootstrap text classes for messages
    function showMsg(el, text, type) {
        el.textContent = text;
        el.className = type === 'success' ? 'text-success' : 'text-danger';
    }
    function clearMsg(el) {
        el.textContent = '';
        el.className = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const u     = getUser();
        const cCamp = document.getElementById('cCampaignId').value.trim();
        if (u)     loadHistory(u);
        if (cCamp) loadComments(cCamp);
    });
</script>
</body>
</html>